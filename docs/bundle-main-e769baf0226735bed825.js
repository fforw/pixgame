var Game=function(e){function t(t){for(var n,o,s=t[0],u=t[1],f=t[2],h=0,c=[];h<s.length;h++)o=s[h],i[o]&&c.push(i[o][0]),i[o]=0;for(n in u)Object.prototype.hasOwnProperty.call(u,n)&&(e[n]=u[n]);for(l&&l(t);c.length;)c.shift()();return a.push.apply(a,f||[]),r()}function r(){for(var e,t=0;t<a.length;t++){for(var r=a[t],n=!0,s=1;s<r.length;s++){var u=r[s];0!==i[u]&&(n=!1)}n&&(a.splice(t--,1),e=o(o.s=r[0]))}return e}var n={},i={2:0},a=[];function o(t){if(n[t])return n[t].exports;var r=n[t]={i:t,l:!1,exports:{}};return e[t].call(r.exports,r,r.exports,o),r.l=!0,r.exports}o.m=e,o.c=n,o.d=function(e,t,r){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(e,t){if(1&t&&(e=o(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(o.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)o.d(r,n,function(t){return e[t]}.bind(null,n));return r},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="";var s=window.webpackJsonpGame=window.webpackJsonpGame||[],u=s.push.bind(s);s.push=t,s=s.slice();for(var f=0;f<s.length;f++)t(s[f]);var l=u;return a.push([19,0]),r()}({19:function(e,t,r){"use strict";r.r(t);var n,i,a,o=r(2),s=(r(5),r(31),r(3)),u=["water.png","water2.png","water3.png","sand.png","sand2.png","sand3.png","grass.png","grass2.png","grass3.png","dirt.png","dirt2.png","dirt3.png","rock.png","rock2.png","rock3.png","woods.png","woods2.png","woods.png","woods2.png","river.png","river2.png","river3.png","marker.png","marker2.png","marker3.png","bunny.png"],f=["none.png","marker2.png","large-tree.png","large-tree2.png","small-tree.png","small-tree2.png","small-tree3.png","plant.png","plant2.png","plant3.png","boulder.png","boulder2.png","marker3.png"];window.onload=function(){n=document.querySelector("div.loading"),o.Loader.shared.add("atlas/atlas-0.json").load(x)};var l=16464,h=19152,c=l,d=h,p=0,v=0,g=0,m=0,b=.5,y=12;function x(e,t){console.log("setup",t),(a=s.f.generate(2048,"floppy-disk")).tiles[0]=s.b;var r=t["atlas/atlas-0.json"].data;console.log("ATLAS",r),n.parentNode.removeChild(n);var x=function(e){for(var t=1,r=e;r>1024;)r/=2,t*=2;return console.log("Set scale to",t),t}(window.innerWidth),w=window.innerWidth/x|0,T=window.innerHeight/x|0,S=w/2,C=T/2,k=Math.ceil(w/16)+5,M=Math.ceil(T/16)+9,A=new o.Application({width:w,height:T,backgroundColor:1118481,resolution:(window.devicePixelRatio||1)*x});function R(e){i.clear();for(var t=e.sizeMask,n=e.fineMask,a=c-S&n,o=d-C&n,s=-32-(15&a),l=-32-(15&o),h=(a>>4)-2&t,p=(o>>4)-2&t,v=d>>4|0,g=0;g<M;g++)for(var m=0;m<k;m++){var b=e.read(h+m&t,p+g&t),y=u[b],x=r.frames[y],w=x.pivot,T=x.frame;i.addFrame(y,s+(m<<4)-(w.x*T.w|0),l+(g<<4)-(w.y*T.h|0))}for(var A=0;A<M;A++){(p+A&t)==(v+1&t)&&(15&d)<8&&i.addFrame("bunny.png",S,C-20);for(var R=0;R<k;R++){var z=e.getThing(h+R&t,p+A&t);if(z>0){var O=f[z];if(!O)throw new Error("No texture for "+z);var P=r.frames[O];w=P.pivot,T=P.frame;i.addFrame(O,s+(R<<4)-w.x*T.w|0,l+(A<<4)-w.y*T.h|0)}}(p+A&t)==(v+1&t)&&(15&d)>=8&&i.addFrame("bunny.png",S,C-20)}i.addFrame("bunny-outline.png",S,C-20)}document.body.appendChild(A.view),i=new o.tilemap.CompositeRectTileLayer(0,o.utils.TextureCache["atlas/atlas-0.json_image"]),R(a),A.stage.addChild(i),A.ticker.add(function(e){g?(p+=g*b,Math.abs(p)>y&&(p=Math.sign(p)*y)):p*=.5,m?(v+=m*b,Math.abs(v)>y&&(v=Math.sign(v)*y)):v*=.5,c=c+p*e&a.fineMask,d=d+v*e&a.fineMask,R(a)}),window.addEventListener("keydown",function(e){switch(e.keyCode){case 36:c=l,d=h;break;case 35:c=0,d=0;break;case 38:case 87:m=-1;break;case 37:case 65:g=-1;break;case 40:case 83:m=1;break;case 39:case 68:g=1}},!0),window.addEventListener("keyup",function(e){switch(e.keyCode){case 38:case 87:case 40:case 83:m=0;break;case 37:case 65:case 39:case 68:g=0}},!0)}},3:function(e,t,r){"use strict";r(5);var n,i,a=r(7),o=r.n(a),s=r(8),u=r(1),f=r.n(u);function l(e,t,r,n){var i,a=e.size,o=e.tiles,s=e.things;switch(n){case 0:case 1:s[(r-1)*a+t-1]=P,s[(r-1)*a+t]=P,s[(r-1)*a+t+1]=P,s[r*a+t-1]=P,L[o[i=r*a+t]]!==T&&(o[i]=G(e,z)),s[r*a+t+1]=P,s[(r+1)*a+t-1]=P,s[(r+1)*a+t]=P,s[(r+1)*a+t+1]=P;break;case 2:s[(r-1)*a+t-1]=P,s[(r-1)*a+t]=P,s[(r-1)*a+t+1]=P,s[(r-1)*a+t+2]=P,s[r*a+t-1]=P,L[o[i=r*a+t]]!==T&&(o[i]=G(e,z)),L[o[i=r*a+t+1]]!==T&&(o[i]=G(e,z)),s[r*a+t+2]=P,s[(r+1)*a+t-1]=P,s[(r+1)*a+t]=P,s[(r+1)*a+t+1]=P,s[(r+1)*a+t+2]=P;break;case 3:s[(r-3)*a+t]=P,s[(r-3)*a+t+1]=P,s[(r-2)*a+t-1]=P,s[(r-2)*a+t]=P,s[(r-2)*a+t+1]=P,s[(r-2)*a+t+2]=P,s[(r-1)*a+t-2]=P,s[(r-1)*a+t-1]=P,L[o[i=(r-1)*a+t]]!==T&&(o[i]=G(e,z)),L[o[i=(r-1)*a+t+1]]!==T&&(o[i]=G(e,z)),s[(r-1)*a+t+2]=P,s[(r-1)*a+t+3]=P,s[r*a+t-2]=P,s[r*a+t-1]=P,L[o[i=r*a+t]]!==T&&(o[i]=G(e,z)),L[o[i=r*a+t+1]]!==T&&(o[i]=G(e,z)),s[r*a+t+2]=P,s[r*a+t+3]=P,s[(r+1)*a+t-1]=P,s[(r+1)*a+t]=P,s[(r+1)*a+t+1]=P,s[(r+1)*a+t+2]=P,s[(r+2)*a+t]=P,s[(r+2)*a+t+1]=P;break;case 4:s[(r-3)*a+t-1]=P,s[(r-3)*a+t]=P,s[(r-3)*a+t+1]=P,s[(r-2)*a+t-2]=P,s[(r-2)*a+t-1]=P,s[(r-2)*a+t]=P,s[(r-2)*a+t+1]=P,s[(r-2)*a+t+2]=P,s[(r-1)*a+t-3]=P,s[(r-1)*a+t-2]=P,L[o[i=(r-1)*a+t-1]]!==T&&(o[i]=G(e,z)),L[o[i=(r-1)*a+t]]!==T&&(o[i]=G(e,z)),L[o[i=(r-1)*a+t+1]]!==T&&(o[i]=G(e,z)),s[(r-1)*a+t+2]=P,s[(r-1)*a+t+3]=P,s[r*a+t-3]=P,s[r*a+t-2]=P,L[o[i=r*a+t-1]]!==T&&(o[i]=G(e,z)),L[o[i=r*a+t]]!==T&&(o[i]=G(e,z)),L[o[i=r*a+t+1]]!==T&&(o[i]=G(e,z)),s[r*a+t+2]=P,s[r*a+t+3]=P,s[(r+1)*a+t-2]=P,s[(r+1)*a+t-1]=P,s[(r+1)*a+t]=P,s[(r+1)*a+t+1]=P,s[(r+1)*a+t+2]=P,s[(r+2)*a+t-1]=P,s[(r+2)*a+t]=P,s[(r+2)*a+t+1]=P;break;case 5:s[(r-3)*a+t-1]=P,s[(r-3)*a+t]=P,s[(r-3)*a+t+1]=P,s[(r-2)*a+t-2]=P,s[(r-2)*a+t-1]=P,s[(r-2)*a+t]=P,s[(r-2)*a+t+1]=P,s[(r-2)*a+t+2]=P,s[(r-1)*a+t-3]=P,s[(r-1)*a+t-2]=P,L[o[i=(r-1)*a+t-1]]!==T&&(o[i]=G(e,z)),L[o[i=(r-1)*a+t]]!==T&&(o[i]=G(e,z)),L[o[i=(r-1)*a+t+1]]!==T&&(o[i]=G(e,z)),s[(r-1)*a+t+2]=P,s[(r-1)*a+t+3]=P,s[r*a+t-3]=P,s[r*a+t-2]=P,L[o[i=r*a+t-1]]!==T&&(o[i]=G(e,z)),L[o[i=r*a+t]]!==T&&(o[i]=G(e,z)),L[o[i=r*a+t+1]]!==T&&(o[i]=G(e,z)),s[r*a+t+2]=P,s[r*a+t+3]=P,s[(r+1)*a+t-3]=P,s[(r+1)*a+t-2]=P,L[o[i=(r+1)*a+t-1]]!==T&&(o[i]=G(e,z)),L[o[i=(r+1)*a+t]]!==T&&(o[i]=G(e,z)),L[o[i=(r+1)*a+t+1]]!==T&&(o[i]=G(e,z)),s[(r+1)*a+t+2]=P,s[(r+1)*a+t+3]=P,s[(r+2)*a+t-2]=P,s[(r+2)*a+t-1]=P,s[(r+2)*a+t]=P,s[(r+2)*a+t+1]=P,s[(r+2)*a+t+2]=P,s[(r+3)*a+t-1]=P,s[(r+3)*a+t]=P,s[(r+3)*a+t+1]=P;break;case 6:s[(r-4)*a+t-1]=P,s[(r-4)*a+t]=P,s[(r-4)*a+t+1]=P,s[(r-3)*a+t-2]=P,s[(r-3)*a+t-1]=P,s[(r-3)*a+t]=P,s[(r-3)*a+t+1]=P,s[(r-3)*a+t+2]=P,s[(r-2)*a+t-3]=P,s[(r-2)*a+t-2]=P,L[o[i=(r-2)*a+t-1]]!==T&&(o[i]=G(e,z)),L[o[i=(r-2)*a+t]]!==T&&(o[i]=G(e,z)),L[o[i=(r-2)*a+t+1]]!==T&&(o[i]=G(e,z)),s[(r-2)*a+t+2]=P,s[(r-2)*a+t+3]=P,s[(r-1)*a+t-4]=P,s[(r-1)*a+t-3]=P,L[o[i=(r-1)*a+t-2]]!==T&&(o[i]=G(e,z)),L[o[i=(r-1)*a+t-1]]!==T&&(o[i]=G(e,z)),L[o[i=(r-1)*a+t]]!==T&&(o[i]=G(e,z)),L[o[i=(r-1)*a+t+1]]!==T&&(o[i]=G(e,z)),L[o[i=(r-1)*a+t+2]]!==T&&(o[i]=G(e,z)),s[(r-1)*a+t+3]=P,s[(r-1)*a+t+4]=P,s[r*a+t-4]=P,s[r*a+t-3]=P,L[o[i=r*a+t-2]]!==T&&(o[i]=G(e,z)),L[o[i=r*a+t-1]]!==T&&(o[i]=G(e,z)),L[o[i=r*a+t]]!==T&&(o[i]=G(e,z)),L[o[i=r*a+t+1]]!==T&&(o[i]=G(e,z)),L[o[i=r*a+t+2]]!==T&&(o[i]=G(e,z)),s[r*a+t+3]=P,s[r*a+t+4]=P,s[(r+1)*a+t-4]=P,s[(r+1)*a+t-3]=P,L[o[i=(r+1)*a+t-2]]!==T&&(o[i]=G(e,z)),L[o[i=(r+1)*a+t-1]]!==T&&(o[i]=G(e,z)),L[o[i=(r+1)*a+t]]!==T&&(o[i]=G(e,z)),L[o[i=(r+1)*a+t+1]]!==T&&(o[i]=G(e,z)),L[o[i=(r+1)*a+t+2]]!==T&&(o[i]=G(e,z)),s[(r+1)*a+t+3]=P,s[(r+1)*a+t+4]=P,s[(r+2)*a+t-3]=P,s[(r+2)*a+t-2]=P,L[o[i=(r+2)*a+t-1]]!==T&&(o[i]=G(e,z)),L[o[i=(r+2)*a+t]]!==T&&(o[i]=G(e,z)),L[o[i=(r+2)*a+t+1]]!==T&&(o[i]=G(e,z)),s[(r+2)*a+t+2]=P,s[(r+2)*a+t+3]=P,s[(r+3)*a+t-2]=P,s[(r+3)*a+t-1]=P,s[(r+3)*a+t]=P,s[(r+3)*a+t+1]=P,s[(r+3)*a+t+2]=P,s[(r+4)*a+t-1]=P,s[(r+4)*a+t]=P,s[(r+4)*a+t+1]=P;break;case 7:s[(r-5)*a+t-1]=P,s[(r-5)*a+t]=P,s[(r-5)*a+t+1]=P,s[(r-4)*a+t-2]=P,s[(r-4)*a+t-1]=P,s[(r-4)*a+t]=P,s[(r-4)*a+t+1]=P,s[(r-4)*a+t+2]=P,s[(r-3)*a+t-3]=P,s[(r-3)*a+t-2]=P,L[o[i=(r-3)*a+t-1]]!==T&&(o[i]=G(e,z)),L[o[i=(r-3)*a+t]]!==T&&(o[i]=G(e,z)),L[o[i=(r-3)*a+t+1]]!==T&&(o[i]=G(e,z)),s[(r-3)*a+t+2]=P,s[(r-3)*a+t+3]=P,s[(r-2)*a+t-4]=P,s[(r-2)*a+t-3]=P,L[o[i=(r-2)*a+t-2]]!==T&&(o[i]=G(e,z)),L[o[i=(r-2)*a+t-1]]!==T&&(o[i]=G(e,z)),L[o[i=(r-2)*a+t]]!==T&&(o[i]=G(e,z)),L[o[i=(r-2)*a+t+1]]!==T&&(o[i]=G(e,z)),L[o[i=(r-2)*a+t+2]]!==T&&(o[i]=G(e,z)),s[(r-2)*a+t+3]=P,s[(r-2)*a+t+4]=P,s[(r-1)*a+t-5]=P,s[(r-1)*a+t-4]=P,L[o[i=(r-1)*a+t-3]]!==T&&(o[i]=G(e,z)),L[o[i=(r-1)*a+t-2]]!==T&&(o[i]=G(e,z)),L[o[i=(r-1)*a+t-1]]!==T&&(o[i]=G(e,z)),L[o[i=(r-1)*a+t]]!==T&&(o[i]=G(e,z)),L[o[i=(r-1)*a+t+1]]!==T&&(o[i]=G(e,z)),L[o[i=(r-1)*a+t+2]]!==T&&(o[i]=G(e,z)),L[o[i=(r-1)*a+t+3]]!==T&&(o[i]=G(e,z)),s[(r-1)*a+t+4]=P,s[(r-1)*a+t+5]=P,s[r*a+t-5]=P,s[r*a+t-4]=P,L[o[i=r*a+t-3]]!==T&&(o[i]=G(e,z)),L[o[i=r*a+t-2]]!==T&&(o[i]=G(e,z)),L[o[i=r*a+t-1]]!==T&&(o[i]=G(e,z)),L[o[i=r*a+t]]!==T&&(o[i]=G(e,z)),L[o[i=r*a+t+1]]!==T&&(o[i]=G(e,z)),L[o[i=r*a+t+2]]!==T&&(o[i]=G(e,z)),L[o[i=r*a+t+3]]!==T&&(o[i]=G(e,z)),s[r*a+t+4]=P,s[r*a+t+5]=P,s[(r+1)*a+t-5]=P,s[(r+1)*a+t-4]=P,L[o[i=(r+1)*a+t-3]]!==T&&(o[i]=G(e,z)),L[o[i=(r+1)*a+t-2]]!==T&&(o[i]=G(e,z)),L[o[i=(r+1)*a+t-1]]!==T&&(o[i]=G(e,z)),L[o[i=(r+1)*a+t]]!==T&&(o[i]=G(e,z)),L[o[i=(r+1)*a+t+1]]!==T&&(o[i]=G(e,z)),L[o[i=(r+1)*a+t+2]]!==T&&(o[i]=G(e,z)),L[o[i=(r+1)*a+t+3]]!==T&&(o[i]=G(e,z)),s[(r+1)*a+t+4]=P,s[(r+1)*a+t+5]=P,s[(r+2)*a+t-4]=P,s[(r+2)*a+t-3]=P,L[o[i=(r+2)*a+t-2]]!==T&&(o[i]=G(e,z)),L[o[i=(r+2)*a+t-1]]!==T&&(o[i]=G(e,z)),L[o[i=(r+2)*a+t]]!==T&&(o[i]=G(e,z)),L[o[i=(r+2)*a+t+1]]!==T&&(o[i]=G(e,z)),L[o[i=(r+2)*a+t+2]]!==T&&(o[i]=G(e,z)),s[(r+2)*a+t+3]=P,s[(r+2)*a+t+4]=P,s[(r+3)*a+t-3]=P,s[(r+3)*a+t-2]=P,L[o[i=(r+3)*a+t-1]]!==T&&(o[i]=G(e,z)),L[o[i=(r+3)*a+t]]!==T&&(o[i]=G(e,z)),L[o[i=(r+3)*a+t+1]]!==T&&(o[i]=G(e,z)),s[(r+3)*a+t+2]=P,s[(r+3)*a+t+3]=P,s[(r+4)*a+t-2]=P,s[(r+4)*a+t-1]=P,s[(r+4)*a+t]=P,s[(r+4)*a+t+1]=P,s[(r+4)*a+t+2]=P,s[(r+5)*a+t-1]=P,s[(r+5)*a+t]=P,s[(r+5)*a+t+1]=P;break;case 8:s[(r-6)*a+t-1]=P,s[(r-6)*a+t]=P,s[(r-6)*a+t+1]=P,s[(r-5)*a+t-3]=P,s[(r-5)*a+t-2]=P,s[(r-5)*a+t-1]=P,s[(r-5)*a+t]=P,s[(r-5)*a+t+1]=P,s[(r-5)*a+t+2]=P,s[(r-5)*a+t+3]=P,s[(r-4)*a+t-4]=P,s[(r-4)*a+t-3]=P,s[(r-4)*a+t-2]=P,L[o[i=(r-4)*a+t-1]]!==T&&(o[i]=G(e,z)),L[o[i=(r-4)*a+t]]!==T&&(o[i]=G(e,z)),L[o[i=(r-4)*a+t+1]]!==T&&(o[i]=G(e,z)),s[(r-4)*a+t+2]=P,s[(r-4)*a+t+3]=P,s[(r-4)*a+t+4]=P,s[(r-3)*a+t-5]=P,s[(r-3)*a+t-4]=P,s[(r-3)*a+t-3]=P,L[o[i=(r-3)*a+t-2]]!==T&&(o[i]=G(e,z)),L[o[i=(r-3)*a+t-1]]!==T&&(o[i]=G(e,z)),L[o[i=(r-3)*a+t]]!==T&&(o[i]=G(e,z)),L[o[i=(r-3)*a+t+1]]!==T&&(o[i]=G(e,z)),L[o[i=(r-3)*a+t+2]]!==T&&(o[i]=G(e,z)),s[(r-3)*a+t+3]=P,s[(r-3)*a+t+4]=P,s[(r-3)*a+t+5]=P,s[(r-2)*a+t-5]=P,s[(r-2)*a+t-4]=P,L[o[i=(r-2)*a+t-3]]!==T&&(o[i]=G(e,z)),L[o[i=(r-2)*a+t-2]]!==T&&(o[i]=G(e,z)),L[o[i=(r-2)*a+t-1]]!==T&&(o[i]=G(e,z)),L[o[i=(r-2)*a+t]]!==T&&(o[i]=G(e,z)),L[o[i=(r-2)*a+t+1]]!==T&&(o[i]=G(e,z)),L[o[i=(r-2)*a+t+2]]!==T&&(o[i]=G(e,z)),L[o[i=(r-2)*a+t+3]]!==T&&(o[i]=G(e,z)),s[(r-2)*a+t+4]=P,s[(r-2)*a+t+5]=P,s[(r-1)*a+t-6]=P,s[(r-1)*a+t-5]=P,L[o[i=(r-1)*a+t-4]]!==T&&(o[i]=G(e,z)),L[o[i=(r-1)*a+t-3]]!==T&&(o[i]=G(e,z)),L[o[i=(r-1)*a+t-2]]!==T&&(o[i]=G(e,z)),L[o[i=(r-1)*a+t-1]]!==T&&(o[i]=G(e,z)),L[o[i=(r-1)*a+t]]!==T&&(o[i]=G(e,z)),L[o[i=(r-1)*a+t+1]]!==T&&(o[i]=G(e,z)),L[o[i=(r-1)*a+t+2]]!==T&&(o[i]=G(e,z)),L[o[i=(r-1)*a+t+3]]!==T&&(o[i]=G(e,z)),L[o[i=(r-1)*a+t+4]]!==T&&(o[i]=G(e,z)),s[(r-1)*a+t+5]=P,s[(r-1)*a+t+6]=P,s[r*a+t-6]=P,s[r*a+t-5]=P,L[o[i=r*a+t-4]]!==T&&(o[i]=G(e,z)),L[o[i=r*a+t-3]]!==T&&(o[i]=G(e,z)),L[o[i=r*a+t-2]]!==T&&(o[i]=G(e,z)),L[o[i=r*a+t-1]]!==T&&(o[i]=G(e,z)),L[o[i=r*a+t]]!==T&&(o[i]=G(e,z)),L[o[i=r*a+t+1]]!==T&&(o[i]=G(e,z)),L[o[i=r*a+t+2]]!==T&&(o[i]=G(e,z)),L[o[i=r*a+t+3]]!==T&&(o[i]=G(e,z)),L[o[i=r*a+t+4]]!==T&&(o[i]=G(e,z)),s[r*a+t+5]=P,s[r*a+t+6]=P,s[(r+1)*a+t-6]=P,s[(r+1)*a+t-5]=P,L[o[i=(r+1)*a+t-4]]!==T&&(o[i]=G(e,z)),L[o[i=(r+1)*a+t-3]]!==T&&(o[i]=G(e,z)),L[o[i=(r+1)*a+t-2]]!==T&&(o[i]=G(e,z)),L[o[i=(r+1)*a+t-1]]!==T&&(o[i]=G(e,z)),L[o[i=(r+1)*a+t]]!==T&&(o[i]=G(e,z)),L[o[i=(r+1)*a+t+1]]!==T&&(o[i]=G(e,z)),L[o[i=(r+1)*a+t+2]]!==T&&(o[i]=G(e,z)),L[o[i=(r+1)*a+t+3]]!==T&&(o[i]=G(e,z)),L[o[i=(r+1)*a+t+4]]!==T&&(o[i]=G(e,z)),s[(r+1)*a+t+5]=P,s[(r+1)*a+t+6]=P,s[(r+2)*a+t-5]=P,s[(r+2)*a+t-4]=P,L[o[i=(r+2)*a+t-3]]!==T&&(o[i]=G(e,z)),L[o[i=(r+2)*a+t-2]]!==T&&(o[i]=G(e,z)),L[o[i=(r+2)*a+t-1]]!==T&&(o[i]=G(e,z)),L[o[i=(r+2)*a+t]]!==T&&(o[i]=G(e,z)),L[o[i=(r+2)*a+t+1]]!==T&&(o[i]=G(e,z)),L[o[i=(r+2)*a+t+2]]!==T&&(o[i]=G(e,z)),L[o[i=(r+2)*a+t+3]]!==T&&(o[i]=G(e,z)),s[(r+2)*a+t+4]=P,s[(r+2)*a+t+5]=P,s[(r+3)*a+t-5]=P,s[(r+3)*a+t-4]=P,s[(r+3)*a+t-3]=P,L[o[i=(r+3)*a+t-2]]!==T&&(o[i]=G(e,z)),L[o[i=(r+3)*a+t-1]]!==T&&(o[i]=G(e,z)),L[o[i=(r+3)*a+t]]!==T&&(o[i]=G(e,z)),L[o[i=(r+3)*a+t+1]]!==T&&(o[i]=G(e,z)),L[o[i=(r+3)*a+t+2]]!==T&&(o[i]=G(e,z)),s[(r+3)*a+t+3]=P,s[(r+3)*a+t+4]=P,s[(r+3)*a+t+5]=P,s[(r+4)*a+t-4]=P,s[(r+4)*a+t-3]=P,s[(r+4)*a+t-2]=P,L[o[i=(r+4)*a+t-1]]!==T&&(o[i]=G(e,z)),L[o[i=(r+4)*a+t]]!==T&&(o[i]=G(e,z)),L[o[i=(r+4)*a+t+1]]!==T&&(o[i]=G(e,z)),s[(r+4)*a+t+2]=P,s[(r+4)*a+t+3]=P,s[(r+4)*a+t+4]=P,s[(r+5)*a+t-3]=P,s[(r+5)*a+t-2]=P,s[(r+5)*a+t-1]=P,s[(r+5)*a+t]=P,s[(r+5)*a+t+1]=P,s[(r+5)*a+t+2]=P,s[(r+5)*a+t+3]=P,s[(r+6)*a+t-1]=P,s[(r+6)*a+t]=P,s[(r+6)*a+t+1]=P;break;default:throw new Error("Unhandled width: "+n)}}function h(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function c(e,t){var r=Object.keys(e);return Object.getOwnPropertySymbols&&r.push.apply(r,Object.getOwnPropertySymbols(e)),t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r}function d(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?c(r,!0).forEach(function(t){p(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):c(r).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}function p(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}r.d(t,"e",function(){return T}),r.d(t,"c",function(){return z}),r.d(t,"b",function(){return O}),r.d(t,"a",function(){return P}),r.d(t,"d",function(){return L}),r.d(t,"g",function(){return G}),r.d(t,"f",function(){return J});var v=2*Math.PI,g=20,m=5;var b=.05,y=.07,x=.09,w=.5,T=0,S=3,C=6,k=9,M=12,A=15,R=16,z=19,O=22,P=1,_=2,I=3,B=10;function D(e){if(!e)return 0;for(var t=0,r=1;r<e.length;r+=2)t+=e[r];return t}var F=["WATER","WATER2","WATER3","SAND","SAND2","SAND3","GRASS","GRASS2","GRASS3","DIRT","DIRT2","DIRT3","ROCK","ROCK2","ROCK3","WOODS","WOODS2","WOODS3","WOODS4","RIVER","RIVER2","RIVER3","MARKER","MARKER2","MARKER3"],E=(p(n={},T,[T,1,2]),p(n,S,[S,4,5]),p(n,C,[C,7,8]),p(n,k,[k,10,11]),p(n,M,[M,13,14]),p(n,A,[A,17]),p(n,R,[R,18]),p(n,z,[z,20,21]),n),L=function(){var e=new Array(F.length);for(var t in E)if(E.hasOwnProperty(t)){var r=+t;e[r]=r;for(var n=E[t],i=0;i<n.length;i++){e[n[i]]=r}}return e}();var j=function(e){for(var t in e)if(e.hasOwnProperty(t)){var r=e[t];if(r)for(var n=D(r),i=1;i<r.length;i+=2)r[i]/=n}return e}((p(i={},T,!1),p(i,S,[0,500,B,1,11,1]),p(i,C,[0,1e3,_,2,I,2,4,3,6,3,B,1,11,2]),p(i,k,[0,1e3,_,2,I,2,4,3,6,3,B,1,11,2]),p(i,M,[0,4,B,1,11,1]),p(i,A,[0,150,_,2,I,2,4,5,5,5,6,5,7,1,8,1,9,1,B,1,11,2]),p(i,R,[0,40,_,2,I,2,4,5,5,5,6,5,7,1,8,1,9,1,B,1,11,2]),p(i,z,!1),i));function G(e,t){var r,n=E[t];if(n){var i=n.length-1;r=0===i?n[0]:n[e.random.nextInt(0,i)]}else r=t;return r}function W(e,t){return L[e]===t}function U(e,t,r){var n=e.things,i=e.sizeMask;if(0===n[t]){var a=j[r];if(a){var o=function(e,t){var r=e.random.next(),n=1;do{r-=t[n],n+=2}while(r>0&&n<t.length);return t[n-3]}(e,a);if(o)if(o===_||o===I){var s=t-2&i,u=t-1&i,f=t+1&i,l=t+2&i,h=t+3&i;n[t-3&i]!==P&&n[s]!==P&&n[u]!==P&&(n[t]=o,n[f]=P,n[l]=P,n[h]=P)}else if(o===B){var c=t+1&i;n[t-1&i]!==P&&(n[t]=o,n[c]=P)}else n[t]=o}}else console.log("Skip spawning on ",n[t])}function V(e,t,r){var n=e.heightCoords(t,r),i=e.heightFn(t,r,n);if(i<b)return T;if(i<y)return S;if(i<w){var a=n.nx,o=n.ny,s=n.nz,u=n.nw,f=i>x?e.noise4D(a*m,u*m,o*m,s*m):1,l=e.noise4D(a*g,u*g,o*g,s*g);return f<0?l<0?A:R:l<0?C:k}return M}function N(e,t){for(var r=new J(e,t),n=r.tiles,i=0,a=0;a<e;a++)for(var o=0;o<e;o++){var s=V(r,o,a);n[i]=G(r,s),U(r,i,s),i++}return r}var K=[0,-1,-1,0,1,0,0,1];function Y(e,t){for(var r=t.value,n=t.x,i=t.y,a=e.size,o=!1,s=0;s<K.length;s+=2){var u=t.x+K[s],f=t.y+K[s+1];if(u>0&&f>0&&u<a&&f<a){var l=e.heightFn(u,f);l>r&&(r=l,n=u,i=f,o=!0)}}return!!o&&{x:n,y:i,value:r,points:[]}}function X(e){var t=function(e){var t=[],r=e.size,n=r*r/1e3;console.log("Probe count =",n);for(var i=0;i<n;i++){var a=e.random.next()*r|0,o=e.random.next()*r|0,s=e.heightFn(a,o);s>b&&t.push({x:a,y:o,value:s,points:[],tile:0})}return t}(e);console.log(t.length,"random probes");var r=e.size,n=t.length,i=0,a=0;for(a=0;a<r/2&&i<n;a++)for(var o=i;o<n;o++){var s=Y(e,t[o]);if(s)t[o]=s;else{var u=t[i];t[i]=t[o],t[o]=u,i++}}var f=function(e){for(var t=e.length,r=[],n=0;n<t;n++){for(var i=e[n],a=!0,o=t-1;o>n;o--){var s=e[o];if(i.x===s.x&&i.y===s.y){a=!1;break}}a&&r.push(i)}return r}(t);return console.log("Stopped climbing after ",a," iterations: "+f.length+" springs"),function(e,t){for(var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:8,n=[],i=0;i<t.length;i++){var a=t[i],o=e.random.nextInt(-r,r),s=e.random.nextInt(-r,r);a.x=a.x+o,a.y=a.y+s,e.heightFn(a.x,a.y)>w&&e.random.next()<.6&&n.push(d({},a,{x:a.x-r-s|0,y:a.y-r+o|0}))}return t.concat(n)}(e,f)}function H(e,t){for(var r=1/0,n=t.x,i=t.y,a=-1,o=-1,s=!1,u=e.size,f=0;f<K.length;f+=2){var l=t.x+K[f],h=t.y+K[f+1];if(l>0&&h>0&&l<u&&h<u){var c=e.read(l,h);if(!W(c,z)){if(W(c,M)){var d=e.heightCoords(l,h),p=d.nx,v=d.ny,m=d.nz,b=d.nw;c=e.noise4D(p*g,b*g,v*g,m*g)<0?C:k}var y=e.heightFn(l,h)-(!W(c,S)&&W(c,t.tile)?.001:0);y<r&&(r=y,n=l,i=h,a=c,o=f,s=!0)}}}if(s){var x=e.random.next();if(x<.25){var w=2*(o/2+(x<.125?-1:1)&3);t.x+=K[w],t.y+=K[w+1],t.points.push(t.x,t.y),t.x+=K[w],t.y+=K[w+1],t.value=1,t.tile=L[e.read(t.x,t.y)]}else t.x=n,t.y=i,t.value=r,t.tile=L[a]}else{var T=2*e.random.nextInt(0,3);t.x+=K[T],t.y+=K[T+1],t.tile=L[e.read(t.x,t.y)]}}function Q(e){var t=X(e),r=e.size,n=t.length,i=0,a=0;for(a=0;a<r&&i<n;a++)for(var o=i;o<n;o++){var s=t[o],u=s.x,f=s.y;if(s.points.push(u,f),W(e.read(s.x,s.y),T)){var h=t[i];t[i]=t[o],t[o]=h,i++}else H(e,s)}console.log("Stopped flowing after ",a," iterations");for(var c=0;c<t.length;c++)for(var d=t[c].points,p=0;p<d.length;p+=2){var v=0|Math.min(8,.004*p);l(e,d[p],d[p+1],v)}for(var g=0;g<t.length;g++)console.log("Spring length",t[g].points.length)}var J=function(){function e(){var t=this,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:800,n=arguments.length>1?arguments[1]:void 0;if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),Math.log(r)/Math.log(2)%1!=0)throw new Error("Size must be power of two: "+r);console.log("New map "+r+" x "+r+", seed = "+n),this.random=new s.a(n),this.noise=new o.a(function(){return t.random.next()}),this.size=r,this.sizeMask=r-1,this.fineMask=(r<<4)-1,this.factor=1/r,this.tiles=new Uint8Array(r*r),this.things=new Uint8Array(r*r)}var t,r,n;return t=e,n=[{key:"generate",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:(new Date).getTime(),r=f()(),n=N(e,t),i=f()();Q(n);var a=f()();return console.log("Base in ".concat(i-r,"ms")),console.log("Rivers in ".concat(a-r,"ms")),console.log({thingStats:n.things.reduce(function(e,t){return e[t]=void 0===e[t]?1:e[t]+1,e},[])}),n}}],(r=[{key:"read",value:function(e,t){return this.tiles[t*this.size+e]}},{key:"getThing",value:function(e,t){return this.things[t*this.size+e]}},{key:"write",value:function(e,t,r){this.tiles[t*this.size+e]=r}},{key:"putThing",value:function(e,t,r){this.things[t*this.size+e]=r}},{key:"heightFn",value:function(e,t,r){var n,i,a,o,s=e*this.factor,u=t*this.factor;r?(n=r.nx,i=r.ny,a=r.nz,o=r.nw):(n=Math.cos(s*v),i=Math.cos(u*v),a=Math.sin(s*v),o=Math.sin(u*v));var f,l=this.noise4D(.4*n,.4*i,.4*a,.4*o),h=this.noise4D(1.4*n,1.4*o,1.4*i,1.4*a);return((f=l<0?-l*l:l*l)<-1?-1:f>1?1:f)+.3*h}},{key:"heightCoords",value:function(e,t){var r=e*this.factor,n=t*this.factor;return{nx:Math.cos(r*v),ny:Math.cos(n*v),nz:Math.sin(r*v),nw:Math.sin(n*v)}}},{key:"render",value:function(e){for(var t=this.size,r=e.createImageData(t,t),n=r.data,i=0,a=0,o=0;o<t;o++)for(var s=0;s<t;s++){switch(this.tiles[i++]){case z:case 20:case 21:n[a++]=255,n[a++]=0,n[a++]=128,n[a++]=255;break;case T:case 1:case 2:n[a++]=0,n[a++]=32,n[a++]=128,n[a++]=255;break;case S:case 4:case 5:n[a++]=192,n[a++]=160,n[a++]=0,n[a++]=255;break;case C:case 7:case 8:n[a++]=0,n[a++]=128,n[a++]=0,n[a++]=255;break;case A:case R:case 17:n[a++]=0,n[a++]=108,n[a++]=16,n[a++]=255;break;case 18:n[a++]=0,n[a++]=64,n[a++]=32,n[a++]=255;break;case k:case 10:case 11:n[a++]=64,n[a++]=64,n[a++]=0,n[a++]=255;break;case M:case 13:case 14:n[a++]=100,n[a++]=100,n[a++]=100,n[a++]=255;break;case O:case 23:case 24:n[a++]=255,n[a++]=0,n[a++]=255,n[a++]=255}}return r}},{key:"noise4D",value:function(e,t,r,n){return this.noise.noise4D(e,t,r,n)}}])&&h(t.prototype,r),n&&h(t,n),e}()},31:function(e,t,r){},5:function(e,t,r){(function(e){!function(t){var r=function(e){this.tileAnim=[0,0],this.dontUseTransform=!1,this.renderer=e,this.tileAnim=[0,0]};t.CanvasTileRenderer=r;var n=e.CanvasRenderer;n&&n.registerPlugin("tilemap",r)}(r||(r={}));var t,r,n=this&&this.__extends||(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])},function(e,r){function n(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)});!function(t){var r=function(r){function i(e,t,n){var i=r.call(this)||this;return i.modificationMarker=0,i.shadowColor=new Float32Array([0,0,0,.5]),i._globalMat=null,i.initialize.apply(i,arguments),i}return n(i,r),i.prototype.updateTransform=function(){this.displayObjectUpdateTransform()},i.prototype.initialize=function(e,r,n){!0===n&&(n=0),this.z=this.zIndex=e,this.texPerChild=n||t.Constant.boundCountPerBuffer*t.Constant.maxTextures,r&&this.setBitmaps(r)},i.prototype.setBitmaps=function(e){var r,n=this.texPerChild,i=this.children.length,a=Math.ceil(e.length/n);for(r=0;r<i;r++)this.children[r].textures=e.slice(r*n,(r+1)*n);for(r=i;r<a;r++){var o=new t.RectTileLayer(this.zIndex,e.slice(r*n,(r+1)*n));o.compositeParent=!0,o.offsetX=t.Constant.boundSize,o.offsetY=t.Constant.boundSize,this.addChild(o)}},i.prototype.clear=function(){for(var e=0;e<this.children.length;e++)this.children[e].clear();this.modificationMarker=0},i.prototype.addRect=function(e,t,r,n,i,a,o){var s=e/this.texPerChild>>0,u=e%this.texPerChild;this.children[s]&&this.children[s].textures&&this.children[s].addRect(u,t,r,n,i,a,o)},i.prototype.addFrame=function(r,n,i,a,o){var s,u=null,f=0,l=this.children;if("number"==typeof r){if(u=l[r/this.texPerChild>>0])f=r%this.texPerChild;else{if(!(u=l[0]))return!1;f=0}s=u.textures[f]}else{s="string"==typeof r?e.Texture.from(r):r;for(var h=0;h<l.length;h++){for(var c=(p=l[h]).textures,d=0;d<c.length;d++)if(c[d].baseTexture===s.baseTexture){u=p,f=d;break}if(u)break}if(!u){for(h=0;h<l.length;h++){var p;if((p=l[h]).textures.length<this.texPerChild){u=p,f=p.textures.length,p.textures.push(s);break}}u||((u=new t.RectTileLayer(this.zIndex,s)).compositeParent=!0,u.offsetX=t.Constant.boundSize,u.offsetY=t.Constant.boundSize,l.push(u),f=0)}}return u.addRect(f,s.frame.x,s.frame.y,n,i,s.frame.width,s.frame.height,a,o),!0},i.prototype.renderCanvas=function(e){if(this.visible&&!(this.worldAlpha<=0)&&this.renderable){if(!e.plugins.tilemap.dontUseTransform){var t=this.worldTransform;e.context.setTransform(t.a,t.b,t.c,t.d,t.tx*e.resolution,t.ty*e.resolution)}for(var r=this.children,n=0;n<r.length;n++)r[n].renderCanvasCore(e)}},i.prototype.render=function(e){if(this.visible&&!(this.worldAlpha<=0)&&this.renderable){var t=e.plugins.tilemap,r=t.getShader();e.batch.setObjectRenderer(t),this._globalMat=r.uniforms.projTransMatrix,e.globalUniforms.uniforms.projectionMatrix.copyTo(this._globalMat).append(this.worldTransform),r.uniforms.shadowColor=this.shadowColor,r.uniforms.animationFrame=t.tileAnim,e.shader.bind(r,!1);for(var n=this.children,i=0;i<n.length;i++)n[i].renderWebGLCore(e,t)}},i.prototype.isModified=function(e){var t=this.children;if(this.modificationMarker!==t.length)return!0;for(var r=0;r<t.length;r++)if(t[r].isModified(e))return!0;return!1},i.prototype.clearModify=function(){var e=this.children;this.modificationMarker=e.length;for(var t=0;t<e.length;t++)e[t].clearModify()},i}(e.Container);t.CompositeRectTileLayer=r}(r||(r={})),function(t){t.Constant={maxTextures:4,bufferSize:2048,boundSize:1024,boundCountPerBuffer:1,use32bitIndex:!1,SCALE_MODE:e.SCALE_MODES.LINEAR,DO_CLEAR:!0}}(r||(r={})),r||(r={}),function(t){function r(e){var r=t.call(this)||this;return r.zIndex=e,r}n(r,t),r.prototype.renderCanvas=function(t){var r=null;t.plugins.tilemap.dontUseTransform&&(r=this.transform.worldTransform,this.transform.worldTransform=e.Matrix.IDENTITY),t.plugins.graphics.render(this),t.plugins.tilemap.dontUseTransform&&(this.transform.worldTransform=r),t.context.globalAlpha=1},r.prototype.isModified=function(e){return!1},r.prototype.clearModify=function(){}}(e.Graphics),function(t){var r=function(r){function i(t){var n=r.call(this,t.bufferSize,t.bufferSize)||this;n.DO_CLEAR=!1,n.boundSize=0,n._clearBuffer=null,n.baseTex=null,n.boundSprites=[],n.dirties=[];var i=n.boundSprites,a=n.dirties;n.boundSize=t.boundSize;for(var o=0;o<t.boundCountPerBuffer;o++){var s=new e.Sprite;s.position.x=t.boundSize*(1&o),s.position.y=t.boundSize*(o>>1),i.push(s),a.push(0)}return n.DO_CLEAR=!!t.DO_CLEAR,n}return n(i,r),i.prototype.bind=function(e){if(this.baseTex)throw new Error("Only one baseTexture is allowed for this resource!");this.baseTex=e,r.prototype.bind.call(this,e)},i.prototype.setTexture=function(e,t){var r=this.boundSprites[e];r.texture.baseTexture!==t.baseTexture&&(r.texture=t,this.baseTex.update(),this.dirties[e]=this.baseTex.dirtyId)},i.prototype.upload=function(e,r,n){var i=e.gl,a=this.width,o=this.height;i.pixelStorei(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL,r.premultiplyAlpha),n.dirtyId<0&&(n.width=a,n.height=o,i.texImage2D(r.target,0,r.format,a,o,0,r.format,r.type,null));var s=this.DO_CLEAR;s&&!this._clearBuffer&&(this._clearBuffer=new Uint8Array(t.Constant.boundSize*t.Constant.boundSize*4));for(var u=this.boundSprites,f=0;f<u.length;f++){var l=u[f],h=l.texture.baseTexture;if(!(n.dirtyId>=this.dirties[f])){var c=h.resource;h.valid&&c&&c.source&&(s&&(h.width<this.boundSize||h.height<this.boundSize)&&i.texSubImage2D(r.target,0,l.position.x,l.position.y,this.boundSize,this.boundSize,r.format,r.type,this._clearBuffer),i.texSubImage2D(r.target,0,l.position.x,l.position.y,r.format,r.type,c.source))}}return!0},i}(e.resources.Resource);t.MultiTextureResource=r}(r||(r={})),function(t){var r=function(r){function i(e,t){var n=r.call(this)||this;return n.zIndex=0,n.modificationMarker=0,n.shadowColor=new Float32Array([0,0,0,.5]),n._globalMat=null,n.pointsBuf=[],n.hasAnim=!1,n.offsetX=0,n.offsetY=0,n.compositeParent=!1,n.vbId=0,n.vb=null,n.vbBuffer=null,n.vbArray=null,n.vbInts=null,n.initialize(e,t),n}return n(i,r),i.prototype.initialize=function(e,t){t?t instanceof Array||!t.baseTexture||(t=[t]):t=[],this.textures=t,this.zIndex=e},i.prototype.clear=function(){this.pointsBuf.length=0,this.modificationMarker=0,this.hasAnim=!1},i.prototype.addFrame=function(t,r,n,i,a){var o,s=0;if("number"==typeof t)s=t,o=this.textures[s];else{o="string"==typeof t?e.Texture.from(t):t;for(var u=!1,f=this.textures,l=0;l<f.length;l++)if(f[l].baseTexture===o.baseTexture){s=l,u=!0;break}if(!u)return!1}return this.addRect(s,o.frame.x,o.frame.y,r,n,o.frame.width,o.frame.height,i,a),!0},i.prototype.addRect=function(e,t,r,n,i,a,o,s,u){void 0===s&&(s=0),void 0===u&&(u=0);var f=this.pointsBuf;if(this.hasAnim=this.hasAnim||s>0||u>0,a===o)f.push(t),f.push(r),f.push(n),f.push(i),f.push(a),f.push(o),f.push(0|s),f.push(0|u),f.push(e);else{var l=void 0;if(a%o==0)for(l=0;l<a/o;l++)f.push(t+l*o),f.push(r),f.push(n+l*o),f.push(i),f.push(o),f.push(o),f.push(0|s),f.push(0|u),f.push(e);else if(o%a==0)for(l=0;l<o/a;l++)f.push(t),f.push(r+l*a),f.push(n),f.push(i+l*a),f.push(a),f.push(a),f.push(0|s),f.push(0|u),f.push(e);else f.push(t),f.push(r),f.push(n),f.push(i),f.push(a),f.push(o),f.push(0|s),f.push(0|u),f.push(e)}},i.prototype.renderCanvas=function(e){if(!e.plugins.tilemap.dontUseTransform){var t=this.worldTransform;e.context.setTransform(t.a,t.b,t.c,t.d,t.tx*e.resolution,t.ty*e.resolution)}this.renderCanvasCore(e)},i.prototype.renderCanvasCore=function(e){if(0!==this.textures.length){var t=this.pointsBuf;e.context.fillStyle="#000000";for(var r=0,n=t.length;r<n;r+=9){var i=t[r],a=t[r+1],o=t[r+2],s=t[r+3],u=t[r+4],f=t[r+5];i+=t[r+6]*e.plugins.tilemap.tileAnim[0],a+=t[r+7]*e.plugins.tilemap.tileAnim[1];var l=t[r+8];l>=0?e.context.drawImage(this.textures[l].baseTexture.source,i,a,u,f,o,s,u,f):(e.context.globalAlpha=.5,e.context.fillRect(o,s,u,f),e.context.globalAlpha=1)}}},i.prototype.destroyVb=function(){this.vb&&(this.vb.destroy(),this.vb=null)},i.prototype.render=function(e){var t=e.plugins.tilemap,r=t.getShader();e.batch.setObjectRenderer(t),this._globalMat=r.uniforms.projTransMatrix,e.globalUniforms.uniforms.projectionMatrix.copyTo(this._globalMat).append(this.worldTransform),r.uniforms.shadowColor=this.shadowColor,r.uniforms.animationFrame=t.tileAnim,e.shader.bind(r,!1),this.renderWebGLCore(e,t)},i.prototype.renderWebGLCore=function(r,n){var i=this.pointsBuf;if(0!==i.length){var a=i.length/9,o=n.getShader(),s=this.textures;if(0!==s.length){n.bindTextures(r,o,s);var u=this.vb;u||(u=n.createVb(),this.vb=u,this.vbId=u.id,this.vbBuffer=null,this.modificationMarker=0),n.checkIndexBuffer(a,u);var f=t.Constant.boundCountPerBuffer,l=u.getBuffer("aVertexPosition"),h=a*u.vertPerQuad;if(0!==h){if(this.modificationMarker!==h){this.modificationMarker=h;var c=u.stride*h;if(!this.vbBuffer||this.vbBuffer.byteLength<c){for(var d=u.stride;d<c;)d*=2;this.vbBuffer=new ArrayBuffer(d),this.vbArray=new Float32Array(this.vbBuffer),this.vbInts=new Uint32Array(this.vbBuffer),l.update(this.vbBuffer)}for(var p=this.vbArray,v=(this.vbInts,0),g=0,m=this.offsetX,b=this.offsetY,y=0;y<i.length;y+=9){this.compositeParent&&(f>1?(g=i[y+8]>>2,m=this.offsetX*(1&i[y+8]),b=this.offsetY*(i[y+8]>>1&1)):(g=i[y+8],m=0,b=0));var x=i[y+2],w=i[y+3],T=i[y+4],S=i[y+5],C=i[y]+m,k=i[y+1]+b,M=i[y+6],A=i[y+7];p[v++]=x,p[v++]=w,p[v++]=C,p[v++]=k,p[v++]=C+.5,p[v++]=k+.5,p[v++]=C+T-.5,p[v++]=k+S-.5,p[v++]=M,p[v++]=A,p[v++]=g,p[v++]=x+T,p[v++]=w,p[v++]=C+T,p[v++]=k,p[v++]=C+.5,p[v++]=k+.5,p[v++]=C+T-.5,p[v++]=k+S-.5,p[v++]=M,p[v++]=A,p[v++]=g,p[v++]=x+T,p[v++]=w+S,p[v++]=C+T,p[v++]=k+S,p[v++]=C+.5,p[v++]=k+.5,p[v++]=C+T-.5,p[v++]=k+S-.5,p[v++]=M,p[v++]=A,p[v++]=g,p[v++]=x,p[v++]=w+S,p[v++]=C,p[v++]=k+S,p[v++]=C+.5,p[v++]=k+.5,p[v++]=C+T-.5,p[v++]=k+S-.5,p[v++]=M,p[v++]=A,p[v++]=g}l.update(p)}r.geometry.bind(u,o),r.geometry.draw(e.DRAW_MODES.TRIANGLES,6*a,0)}}}},i.prototype.isModified=function(e){return!!(this.modificationMarker!==this.pointsBuf.length||e&&this.hasAnim)},i.prototype.clearModify=function(){this.modificationMarker=this.pointsBuf.length},i.prototype.destroy=function(e){r.prototype.destroy.call(this,e),this.destroyVb()},i}(e.Container);t.RectTileLayer=r}(r||(r={})),function(t){var r="\nvarying vec2 vTextureCoord;\nvarying vec4 vFrame;\nvarying float vTextureId;\nuniform vec4 shadowColor;\nuniform sampler2D uSamplers[%count%];\nuniform vec2 uSamplerSize[%count%];\n\nvoid main(void){\n   vec2 textureCoord = clamp(vTextureCoord, vFrame.xy, vFrame.zw);\n   float textureId = floor(vTextureId + 0.5);\n\n   vec4 color;\n   %forloop%\n   gl_FragColor = color;\n}\n",i="\nattribute vec2 aVertexPosition;\nattribute vec2 aTextureCoord;\nattribute vec4 aFrame;\nattribute vec2 aAnim;\nattribute float aTextureId;\n\nuniform mat3 projTransMatrix;\nuniform vec2 animationFrame;\n\nvarying vec2 vTextureCoord;\nvarying float vTextureId;\nvarying vec4 vFrame;\n\nvoid main(void){\n   gl_Position = vec4((projTransMatrix * vec3(aVertexPosition, 1.0)).xy, 0.0, 1.0);\n   vec2 anim = aAnim * animationFrame;\n   vTextureCoord = aTextureCoord + anim;\n   vFrame = aFrame + vec4(anim, anim);\n   vTextureId = aTextureId;\n}\n",a=function(r){function i(n,i,a){var o=r.call(this,new e.Program(i,a),{animationFrame:new Float32Array(2),uSamplers:[],uSamplerSize:[],projTransMatrix:new e.Matrix})||this;return o.maxTextures=0,o.maxTextures=n,t.shaderGenerator.fillSamplers(o,o.maxTextures),o}return n(i,r),i}(e.Shader);t.TilemapShader=a;var o=function(e){function a(n){var a=e.call(this,n,i,t.shaderGenerator.generateFragmentSrc(n,r))||this;return t.shaderGenerator.fillSamplers(a,a.maxTextures),a}return n(a,e),a}(a);t.RectTileShader=o;var s=function(t){function r(){var r=t.call(this)||this;r.vertSize=11,r.vertPerQuad=4,r.stride=4*r.vertSize,r.lastTimeAccess=0;var n=r.buf=new e.Buffer(new Float32Array(2),!0,!1);return r.addAttribute("aVertexPosition",n,0,!1,0,r.stride,0).addAttribute("aTextureCoord",n,0,!1,0,r.stride,8).addAttribute("aFrame",n,0,!1,0,r.stride,16).addAttribute("aAnim",n,0,!1,0,r.stride,32).addAttribute("aTextureId",n,0,!1,0,r.stride,40),r}return n(r,t),r}(e.Geometry);t.RectTileGeom=s}(r||(r={})),function(t){var r=function(r){function i(n){var i=r.call(this,n)||this;return i.sn=-1,i.indexBuffer=null,i.ibLen=0,i.tileAnim=[0,0],i.texLoc=[],i.texResources=[],i.rectShader=new t.RectTileShader(t.Constant.maxTextures),i.indexBuffer=new e.Buffer(void 0,!0,!0),i.checkIndexBuffer(2e3),i.initBounds(),i}return n(i,r),i.prototype.initBounds=function(){if(!(t.Constant.boundCountPerBuffer<=1))for(var r=t.Constant.maxTextures,n=0;n<r;n++){var i=new t.MultiTextureResource(t.Constant),a=new e.BaseTexture(i);a.scaleMode=t.Constant.SCALE_MODE,a.wrapMode=e.WRAP_MODES.CLAMP,this.texResources.push(i)}},i.prototype.bindTexturesWithoutRT=function(e,t,r){var n=t.uniforms.uSamplerSize;this.texLoc.length=0;for(var i=0;i<r.length;i++){var a=r[i];if(!a||!a.valid)return;e.texture.bind(r[i],i),n[2*i]=1/r[i].baseTexture.width,n[2*i+1]=1/r[i].baseTexture.height}t.uniforms.uSamplerSize=n},i.prototype.bindTextures=function(e,r,n){var i=n.length,a=t.Constant.maxTextures;if(!(i>t.Constant.boundCountPerBuffer*a))if(t.Constant.boundCountPerBuffer<=1)this.bindTexturesWithoutRT(e,r,n);else{for(var o=0;o<i;o++){var s=n[o];if(s&&s.valid)this.texResources[o>>2].setTexture(3&o,s)}var u=o+3>>2;for(o=0;o<u;o++)e.texture.bind(this.texResources[o].baseTex,o)}},i.prototype.start=function(){},i.prototype.createVb=function(){var e=new t.RectTileGeom;return e.addIndex(this.indexBuffer),e.lastTimeAccess=Date.now(),e},i.prototype.checkIndexBuffer=function(r,n){void 0===n&&(n=null);var i=6*r;if(!(i<=this.ibLen)){for(var a=i;a<i;)a<<=1;this.ibLen=i,this.indexBuffer.update(e.utils.createIndicesForQuads(r,t.Constant.use32bitIndex))}},i.prototype.getShader=function(){return this.rectShader},i.prototype.destroy=function(){r.prototype.destroy.call(this),this.rectShader=null},i}(e.ObjectRenderer);t.TileRenderer=r,e.Renderer.registerPlugin("tilemap",r)}(r||(r={})),function(t){var r=function(t){function r(e,r){var n=t.call(this)||this;return n._lastAnimationFrame=-1,n.tilemap=e,n.z=r,n}return n(r,t),r.prototype.clear=function(){for(var e=this.children,t=0;t<e.length;t++)e[t].clear();this._previousLayers=0},r.prototype.cacheIfDirty=function(){var t=this.tilemap,r=this.children,n=this._previousLayers!==r.length;this._previousLayers=r.length;var i,a=this.canvasBuffer,o=this._tempRender;if(a||(a=this.canvasBuffer=document.createElement("canvas"),(o=this._tempRender=new e.CanvasRenderer(100,100,{view:a})).context=o.rootContext,o.plugins.tilemap.dontUseTransform=!0),a.width===t._layerWidth&&a.height===t._layerHeight||(a.width=t._layerWidth,a.height=t._layerHeight,n=!0),!n)for(i=0;i<r.length;i++)if(r[i].isModified(this._lastAnimationFrame!==t.animationFrame)){n=!0;break}if(this._lastAnimationFrame=t.animationFrame,n)for(t._hackRenderer&&t._hackRenderer(o),o.context.clearRect(0,0,a.width,a.height),i=0;i<r.length;i++)r[i].clearModify(),r[i].renderCanvas(o);for(this.layerTransform=this.worldTransform,i=0;i<r.length;i++){this.layerTransform=r[i].worldTransform;break}},r.prototype.renderCanvas=function(e){this.cacheIfDirty();var t=this.layerTransform;e.context.setTransform(t.a,t.b,t.c,t.d,t.tx*e.resolution,t.ty*e.resolution);this.tilemap;e.context.drawImage(this.canvasBuffer,0,0)},r}(e.Container);t.ZLayer=r}(r||(r={})),function(t){e.tilemap=t}(r||(r={})),function(e){!function(t){t.fillSamplers=function(t,r){for(var n=[],i=0;i<r;i++)n[i]=i;t.uniforms.uSamplers=n;var a=[];for(i=0;i<r;i++)a.push(1/e.Constant.bufferSize),a.push(1/e.Constant.bufferSize);t.uniforms.uSamplerSize=a},t.generateFragmentSrc=function(e,t){return t.replace(/%count%/gi,e+"").replace(/%forloop%/gi,this.generateSampleSrc(e))},t.generateSampleSrc=function(e){var t="";t+="\n",t+="\n",t+="if(vTextureId <= -1.0) {",t+="\n\tcolor = shadowColor;",t+="\n}";for(var r=0;r<e;r++)t+="\nelse ",r<e-1&&(t+="if(textureId == "+r+".0)"),t+="\n{",t+="\n\tcolor = texture2D(uSamplers["+r+"], textureCoord * uSamplerSize["+r+"]);",t+="\n}";return t+="\n",t+="\n"}}(e.shaderGenerator||(e.shaderGenerator={}))}(r||(r={}))}).call(this,r(2))}});
//# sourceMappingURL=bundle-main-e769baf0226735bed825.js.map